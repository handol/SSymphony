<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<title>Matrix Tool</title>
	<meta name="description" content="Matrix Tool" />
	<link rel="stylesheet" href="./css/matrix.css">
	<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script src="./lib/socket.io.js"></script>	
	<script>		
		var tmpClient = 0;	//현재 클라이언트 번호
		var tmpGroup = "matrix-group-1";	//현재 그룹
		var toolName = "matrix";
		var setupData = { row:0, col:0 }; // matrix 행, 열
		var setupFlag = { data_init:false, row:false, col:false };
		var optionId = { clear:999999, row:999998, col:999997 };
		var boxCount = 0; // lastId 가 세팅 되어 있는 input 이 있는 박스 갯수
		var totalBoxCount = 0; // row * col 총 박스 갯수
		var setFlag = 0;
		var clientColor = new Array( "none", "#99FF99", "#CCCC99", "#0099FF", "#CCFFCC", "#FFFF66", "#FF9999", "#669999", "#9999FF", "#00CCCC", "#CC9900");	

		var inputFlag = 0;	//키입력 감지하기 위한 변수

		////  socket.io 서버의 해당 그룹에 접속  ////
		var socket = io.connect('http://61.43.139.69:8000/group');	// socket.io 서버에 접속

		////  처음 창 오픈되었을 때 호출  ////
		$(document).ready(function() {
			socket.emit('join_room', { group: tmpGroup });

			socket.on('get_client', function (data) {
				console.log(data);
			});
			
			////  서버에 초기 데이터 요청하는 함수  ////
			socket.emit('set_data', { group: tmpGroup, tool: toolName });
			
			socket.on('get_data', function (data) {
				console.log(data);
			});
		}); 
		
		function setMatrix(){
			if( setupFlag.data_init == false )
			{
				setupData.row = $('#rowNum').val();
				setupData.col = $('#colNum').val();
				setupFlag.data_init = true;
				setupFlag.row = true;
				setupFlag.col = true;
				socket.emit('set_init_tool_data', { group: tmpGroup, tool: toolName });		
				socket.emit('set_option_data', { group: tmpGroup, tool: toolName, id: optionId.row, option: "row", val: setupData.row });
				socket.emit('set_option_data', { group: tmpGroup, tool: toolName, id: optionId.col, option: "col", val: setupData.col });
				setDoMatrix();
			}
		}

		function setClear() {
			if( confirm("정말 삭제하겠습니까?") ) {
				socket.emit('set_option_data', { group: tmpGroup, tool: toolName, id: optionId.row, option: "row", val: false });
				socket.emit('set_option_data', { group: tmpGroup, tool: toolName, id: optionId.col, option: "col", val: false });
				socket.emit('set_option_data', { group: tmpGroup, tool: toolName, id: optionId.clear, option: "clear", val: true });
				setDoClear();
			}
		}

		function setDoClear() {
			setupFlag.data_init = false;
			$('#matrix_table tbody').html("");
			$('#matrix_table colgroup').html("");
		}

		function setDoMatrix() {
			if( setupFlag.data_init && setupFlag.row && setupFlag.col )
			{
				var tmpRow = setupData.row;
				var tmpCol = setupData.col;
				totalBoxCount = (tmpRow*1)*(tmpCol*1);
				//alert("row: "+tmpRow+" / col: "+tmpCol);
				var tmpMatrix = $('#matrix_table tbody');
				var colGroup =  $('#matrix_table colgroup');
				var tmpTag = "";
				var colWidth = $('#matrix_table').width() / ((tmpCol*1));

				var i=0, j=0;
				for (i=0; i<parseInt(tmpRow); i++) {
					tmpTag = "<tr class='row'></tr>";
					tmpMatrix.append(tmpTag);
					for (j=0; j<parseInt(tmpCol); j++) {
						if (i==0)
							colGroup.append("<col width='"+colWidth+"px'>");

						var tmpInsertRow = tmpMatrix.find('.row:last');
						tmpTag = "<td><div class='input_line matrix-box' idx='"+( (i*tmpCol)+j )+"'></div></td>";
						tmpInsertRow.append(tmpTag);
						socket.emit('set_last_id', { group: tmpGroup, tool: toolName });
					}
				}

				$('#matrix_table tr:nth-child(even) td:nth-child(even)').addClass("even");
				$('#matrix_table tr:nth-child(even) td:nth-child(odd)').addClass("c-even");
				$('#matrix_table tr:nth-child(odd) td:nth-child(even)').addClass("odd");
				$('#matrix_table tr:nth-child(odd) td:nth-child(odd)').addClass("c-odd");

				$('.matrix-box').click(function(e){
					if( e.target.localName == "div" )
						$('input:last', this).focus();					
				});
			}
		}

		function addInput(t, e)
		{
			var $div = $(t).parent();
			if( e.keyCode == 13 && $(t).val().trim().length > 0 )
			{
				var taskId = $(t).attr("taskid");
				var idx = $(t).parent().attr("idx");
				var val = $(t).val();
				socket.emit('set_insert_data', { group: tmpGroup, tool: toolName, id: taskId, index: idx, val: val });
				socket.emit('set_last_id', { group: tmpGroup, tool: toolName });
			}
			else if( (e.keyCode == 8 ) && $(t).val().trim().length < 1 && $("input",$div).length > 1 )
			{
				$(t).remove();
				var taskId = $(t).attr("taskid");
				socket.emit('set_delete_data', { group: tmpGroup, tool: toolName, id: taskId });
				$("input",$div).focus();
				return false;
			}
			return true;
		}

		function makeInputbox(w, lastId)
		{
			var html = "<input taskid='"+lastId+"' type='text' class='matrix-input' name='matrix-input' style='width:"+w+"px' onkeydown='javascript:return addInput(this, event);' onfocus='focusInput(this);'>";
			return html
		}

		// 이전에 작성중이였던 box를 찾아서 input 추가
		function addInputbox( lastId )
		{
			// 작성중이였던 input select
			var $input = $('.writing');
			$input.removeClass("writing");
			// 작성중이였던 div select
			var $div = $input.parent();
			var w = $div.width() - 4;
			$div.append(makeInputbox(w, lastId));
			$('input:last', $div).focus();
			var h = $div.height();
			var td_obj = $div.parent().parent();
			$("div.matrix-box", td_obj).css("min-height", h+"px");
			$('input:last', $div).focus();
		}
		// 초기 box 생성시 input 생성
		function setupBox(lastId)
		{
			var $div = $(".matrix-box:not(input):nth-child("+boxCount+")");
			var w = $div.width() - 4;
			$div.append(makeInputbox(w, lastId))
			boxCount++;
		}

		function focusInput(t)
		{
			$(".writing").removeClass("writing");
			$(t).addClass("writing");
		}

		// matrix setup
		socket.on('get_init_tool_data', function (data) {
			setupFlag.data_init = true;
			setDoMatrix();
		});
		socket.on('get_option_data', function (data) {
			if( data.option == "row" && data.val )
			{
				setupFlag.row = true;
				setupData.row = data.val;
				setDoMatrix();
			}
			else if( data.option == "row" && !data.val )
			{
				setupFlag.row = false;
				setupData.row = 0;
			}
			else if( data.option == "col" && data.val )
			{
				setupFlag.col = true;
				setupData.col = data.val;
				setDoMatrix();
			}
			else if( data.option == "col" && !data.val )
			{
				setupFlag.col = false;
				setupData.col = 0;
			}
			else if( data.option == "clear" && data.val )
				setDoClear();
		});

		socket.on('get_insert_data', function (data) {
			console.log(data);
		});

		socket.on('get_delete_data', function (data) {
			console.log(data);			
		});

		socket.on('get_last_id', function (data) {
			var tmpTool = data.tool; 
			lastId = data.last;
			if( totalBoxCount != boxCount )
				setupBox(lastId);
			else
				addInputbox(lastId);
		});

	</script>
</head>
<body>
<div id="wrapper">
	<header id="main_header">
		<h1>Matrix Tool</h1>
	</header>
	<div id="container">
    <section id="main_section">
		<article>
			<header>
				<div class="menu_line">
					
					<div class="size_box" >
						<input type="number" class="inputNum" id="rowNum" value="2">
						X
						<input type="number" class="inputNum" id="colNum" value="2">				
					</div>		
					<div id="setNum" onClick="setMatrix()" ><h2>Set</h2></div>
					<div class="init_box">
						<div id="initButton" onClick="setClear()"><h2>Clear</h2></div>
					</div>
				</div>
			</header>
			<div class="matrix_space">
				<table id="matrix_table">
					<thead><colgroup></colgroup></thead>
					<tbody></tbody>
				</table>
			</div>
		</article>
    </section>
	</div>
</div>
</body>
</html>
